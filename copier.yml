# NOTE some limitations of copier:
#
#   - any extensions must be installed manually
#   - you cannot use dst_path as default answers

_min_copier_version: 9.4.1

_answers_file: .copier/.copier-answers.yml

_jinja_extensions:
  - jinja2_shell_extension.ShellExtension

_message_after_copy: |
  Next steps:

    1. Customize secrets in .envrc{% if not include_postgres %}, no database/cache configuration was included{% endif %}.
    2. Run `direnv allow`
    3. Set GH_TOKEN on GH actions{% if include_postgres %}
    4. docker-compose.yml includes PostgreSQL and Redis. Remove it if you don't need it (you'll also have to update the github workflows that depend on it).{% endif %}
    {% if add_llm_rules %}6. LLM IDE rules have been added to improve AI-assisted development.{% endif %}

project_name:
  type: str
  help: Dash separated project slug
  default: "{{ \"basename $(pwd)\" | shell() | trim | regex_replace(' ', '-') | regex_replace('_', '-') }}"
  validator: >-
    {% if not (project_name | regex_search('^[a-z][a-z0-9-_]+$')) %}
    project_name must start with a letter, followed one or more letters, digits or dashes all lowercase.
    {% endif %}

# https://github.com/superlinear-ai/substrate/blob/main/copier.yml
project_name_snake_case:
  when: false
  default: "{{ project_name | lower | replace('-', '_') }}"

full_name:
  type: str
  help: Full name of the project owner (for pypi)
  default: "{{ \"git config --global user.name\" | shell() | trim }}"

email:
  type: str
  help: Email of the project owner (for pypi)
  default: "{{ \"git config --global user.email\" | shell() | trim }}"

github_username:
  type: str
  help: GitHub username of the project owner (for pypi)
  default: "{{ \"gh api user --jq '.login'\" | shell() | trim }}"

build_workflow:
  type: str
  help: |
    Choose the GitHub Actions workflow for building and publishing.
    - release_please: Release Please (automated releases, single OS)
    - release_please_matrix: Release Please with Test Matrix (automated releases, cross-platform testing)
    - manual_matrix: Manual Releases with Test Matrix (manual releases, cross-platform testing)
  choices:
    - release_please
    - release_please_matrix
    - manual_matrix
  default: release_please

publish_docker_image:
  type: bool
  help: Build and publish a Docker image to ghcr.io?
  default: false

add_llm_rules:
  type: bool
  help: Add LLM IDE rules for better AI-assisted development (GitHub Copilot, Cursor, etc.)?
  default: false

include_postgres:
  type: bool
  help: Do you want to include PostgreSQL and Redis support (via docker-compose)?
  default: true

_exclude:
  - TODO
  - /.git
  - /README.md
  - /CHANGELOG.md
  - /LICENSE
  - /uv.lock
  - /metadata.json
  - /copier.yml

_tasks:
  - |
    # Remove unused workflow files based on build_workflow choice
    if [ "{{ build_workflow }}" = "release_please" ]; then
      rm -f .github/workflows/build_and_publish_release_please_test_matrix.yml
      rm -f .github/workflows/build_and_publish_test_matrix.yml
      mv .github/workflows/build_and_publish_release_please.yml .github/workflows/build_and_publish.yml
    elif [ "{{ build_workflow }}" = "release_please_matrix" ]; then
      rm -f .github/workflows/build_and_publish_release_please.yml
      rm -f .github/workflows/build_and_publish_test_matrix.yml
      mv .github/workflows/build_and_publish_release_please_test_matrix.yml .github/workflows/build_and_publish.yml
    elif [ "{{ build_workflow }}" = "manual_matrix" ]; then
      rm -f .github/workflows/build_and_publish_release_please.yml
      rm -f .github/workflows/build_and_publish_release_please_test_matrix.yml
      mv .github/workflows/build_and_publish_test_matrix.yml .github/workflows/build_and_publish.yml
    fi
  - |
    # Remove docker-compose.yml if database/cache services are not included
    if [ "{{ include_postgres }}" = "False" ]; then
      rm -f docker-compose.yml
    fi
  - uv sync
  - |
    # Initialize and commit only if not already a git repo
    if ! git rev-parse --is-inside-work-tree >/dev/null 2>&1; then
      git init
      git add -A
      git commit -m "ðŸŽ‰ Initial commit"
    fi
  - |
    # Add LLM IDE rules if requested
    if [ "{{ add_llm_rules }}" = "True" ]; then
      echo "Adding LLM IDE rules..."
      uvx llm-ide-rules download --repo https://github.com/iloveitaly/python-package-prompts
      git add -A && git commit -m "LLM rules"
    fi

# although it's annoying to have the .copier-answers.yml file in the root, it allows `copier update`
# to work properly
